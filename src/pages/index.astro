---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// Get all published blog posts
const allPosts = await getCollection('blog', ({ data }) => !data.draft);

// Sort by date (newest first)
const posts = allPosts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Featured posts first
const featuredPosts = posts.filter((post) => post.data.featured);
const regularPosts = posts.filter((post) => !post.data.featured);

// Get unique categories and tags
const categories = [...new Set(posts.map((post) => post.data.category))];
const allTags = posts.flatMap((post) => post.data.tags);
const tags = [...new Set(allTags)];

const formatDate = (date: Date) => {
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
};
---

<BaseLayout>
  <div class="container container-wide">
    <header class="hero">
      <h1>Athallari Zky</h1>
      <p class="subtitle">
        Frontend architect & DevOps engineer. Writing about software engineering, web development,
        and infrastructure.
      </p>
      <div class="hero-meta">
        <span class="stat">{posts.length} posts</span>
        <span class="stat">{categories.length} categories</span>
        <span class="stat">{tags.length} tags</span>
      </div>
    </header>

    {
      featuredPosts.length > 0 && (
        <section class="section">
          <h2 class="section-title">Featured</h2>
          <div class="posts-list">
            {featuredPosts.map((post) => (
              <a href={`/blog/${post.slug}/`} class="post-item">
                <article>
                  <div class="post-meta">
                    <span class="post-label">Featured</span>
                    <span class="separator">—</span>
                    <time datetime={post.data.pubDate.toISOString()} class="post-date">
                      {formatDate(post.data.pubDate)}
                    </time>
                  </div>
                  <h3 class="post-title">{post.data.title}</h3>
                  <p class="post-description">{post.data.description}</p>
                </article>
              </a>
            ))}
          </div>
        </section>
      )
    }

    {
      regularPosts.length > 0 && (
        <section class="section">
          <h2 class="section-title">Latest</h2>
          <div class="posts-list">
            {regularPosts.map((post) => (
              <a href={`/blog/${post.slug}/`} class="post-item">
                <article>
                  <div class="post-meta">
                    <time datetime={post.data.pubDate.toISOString()} class="post-date">
                      {formatDate(post.data.pubDate)}
                    </time>
                    <span class="separator">—</span>
                    <span class="post-category">{post.data.category}</span>
                  </div>
                  <h3 class="post-title">{post.data.title}</h3>
                  <p class="post-description">{post.data.description}</p>
                </article>
              </a>
            ))}
          </div>
        </section>
      )
    }

    <section class="section tags-section">
      <h2 class="section-title">Topics</h2>
      <div class="tags-cloud">
        {
          tags.map((tag) => (
            <a href={`/tags/${tag}/`} class="tag-link">
              #{tag}
            </a>
          ))
        }
      </div>
    </section>
  </div>
</BaseLayout>

<style>
  .hero {
    padding: 6rem 0 4rem;
  }

  .hero h1 {
    font-size: clamp(2.5rem, 8vw, 4rem);
    margin-bottom: 1.5rem;
  }

  .subtitle {
    font-size: 1.25rem;
    color: var(--color-text-muted);
    max-width: 650px;
    margin-bottom: 2rem;
    line-height: 1.6;
  }

  .hero-meta {
    display: flex;
    gap: 1.5rem;
    font-size: 0.875rem;
    color: var(--color-text-muted);
  }

  .section {
    padding: 3rem 0;
  }

  .section-title {
    font-size: 1.125rem;
    color: var(--color-text-muted);
    margin-bottom: 2rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-weight: 500;
  }

  .posts-list {
    display: flex;
    flex-direction: column;
    gap: 3.5rem;
  }

  .post-item {
    display: block;
    text-decoration: none;
    transition: opacity 0.2s ease;
  }

  .post-item:hover {
    opacity: 0.6;
    text-decoration: none;
  }

  .post-meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.875rem;
    margin-bottom: 0.75rem;
    color: var(--color-text-muted);
  }

  .post-label {
    color: var(--color-text);
    font-weight: 600;
  }

  .separator {
    color: var(--color-border);
  }

  .post-title {
    font-size: 1.75rem;
    margin-bottom: 0.5rem;
    font-weight: 600;
    line-height: 1.3;
  }

  .post-description {
    font-size: 1.125rem;
    color: var(--color-text-muted);
    margin: 0;
    max-width: 75ch;
  }

  .tags-cloud {
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
  }

  .tag-link {
    font-size: 1rem;
    color: var(--color-text-muted);
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .tag-link:hover {
    color: var(--color-text);
  }

  @media (max-width: 640px) {
    .hero {
      padding: 4rem 0 2rem;
    }

    .posts-list {
      gap: 2.5rem;
    }

    .post-title {
      font-size: 1.5rem;
    }
  }
</style>
